<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content {{cookiecutter.description}}&quot;&quot;><meta name=author content={{cookiecutter.author_name}}><link rel=icon href=../../assets/favicon.svg><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.1.5"><title>CI/CD - {{cookiecutter.project_name}}</title><link rel=stylesheet href=../../assets/stylesheets/main.bde7dde4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ef6f36e2.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style></head> <body dir=ltr data-md-color-scheme=aisg data-md-color-primary=red data-md-color-accent=red> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#continuous-integration-deployment class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title={{cookiecutter.project_name}} class="md-header__button md-logo" aria-label={{cookiecutter.project_name}} data-md-component=logo> <img src=../../assets/aisg-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> {{cookiecutter.project_name}} </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> CI/CD </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=aisg data-md-color-primary=red data-md-color-accent=red type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/aisingapore/ml-project-cookiecutter-gcp title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aisingapore/ml-project-cookiecutter-gcp </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../01-prerequisites/ class="md-tabs__link md-tabs__link--active"> User Guide </a> </li> <li class=md-tabs__item> <a href=../../guide-for-admin/01-prerequisites/ class=md-tabs__link> Admin Guide </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title={{cookiecutter.project_name}} class="md-nav__button md-logo" aria-label={{cookiecutter.project_name}} data-md-component=logo> <img src=../../assets/aisg-logo.png alt=logo> </a> {{cookiecutter.project_name}} </label> <div class=md-nav__source> <a href=https://github.com/aisingapore/ml-project-cookiecutter-gcp title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aisingapore/ml-project-cookiecutter-gcp </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> User Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User Guide" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01-prerequisites/ class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=../02-preface/ class=md-nav__link> Preface </a> </li> <li class=md-nav__item> <a href=../03-mlops-components-platform/ class=md-nav__link> MLOps Components & Platform </a> </li> <li class=md-nav__item> <a href=../04-dev-env/ class=md-nav__link> Development Environment </a> </li> <li class=md-nav__item> <a href=../05-virtual-env/ class=md-nav__link> Virtual Environment </a> </li> <li class=md-nav__item> <a href=../06-data-storage-versioning/ class=md-nav__link> Data Storage & Versioning </a> </li> <li class=md-nav__item> <a href=../07-job-orchestration/ class=md-nav__link> Job Orchestration </a> </li> <li class=md-nav__item> <a href=../08-deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../09-batch-inferencing/ class=md-nav__link> Batch Inferencing </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> CI/CD <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> CI/CD </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#github-flow class=md-nav__link> GitHub Flow </a> </li> <li class=md-nav__item> <a href=#environment-variables class=md-nav__link> Environment Variables </a> </li> <li class=md-nav__item> <a href=#stages-jobs class=md-nav__link> Stages &amp; Jobs </a> </li> <li class=md-nav__item> <a href=#automated-testing-linting class=md-nav__link> Automated Testing &amp; Linting </a> </li> <li class=md-nav__item> <a href=#automated-builds class=md-nav__link> Automated Builds </a> </li> <li class=md-nav__item> <a href=#tagging class=md-nav__link> Tagging </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> Conclusion </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../11-documentation/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../12-streamlit/ class=md-nav__link> Streamlit </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Admin Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Admin Guide" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Admin Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guide-for-admin/01-prerequisites/ class=md-nav__link> Prerequisites </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#github-flow class=md-nav__link> GitHub Flow </a> </li> <li class=md-nav__item> <a href=#environment-variables class=md-nav__link> Environment Variables </a> </li> <li class=md-nav__item> <a href=#stages-jobs class=md-nav__link> Stages &amp; Jobs </a> </li> <li class=md-nav__item> <a href=#automated-testing-linting class=md-nav__link> Automated Testing &amp; Linting </a> </li> <li class=md-nav__item> <a href=#automated-builds class=md-nav__link> Automated Builds </a> </li> <li class=md-nav__item> <a href=#tagging class=md-nav__link> Tagging </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> Conclusion </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=continuous-integration-deployment>Continuous Integration &amp; Deployment<a class=headerlink href=#continuous-integration-deployment title="Permanent link">&para;</a></h1> <p>This template presents users with a base configuration for a GitLab CI/CD pipeline. In this section, the guide aims to provide readers with some basic understanding of the pipeline defined in the configuration file <code>.gitlab-ci.yml</code>.</p> <p>That being said, readers would certainly benefit from reading up on <a href=https://docs.gitlab.com/ee/ci/introduction/ >introductory CI/CD concepts</a> as introduced by GitLab's Docs.</p> <div class=video-wrapper> <iframe width=1280 height=720 src="https://www.youtube.com/embed/l5705U8s_nQ?start=392" title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> </div> <h2 id=github-flow>GitHub Flow<a class=headerlink href=#github-flow title="Permanent link">&para;</a></h2> <p>The defined pipeline assumes a GitHub flow which only relies on feature branches and a <code>master</code>/<code>main</code> (default) branch.</p> <p><img alt="AISG's GitHub Flow Diagram" src=../../assets/images/github-flow-aisg-diagram.png></p> <p>With reference to the diagram above, we have the following pointers:</p> <ul> <li>We make use of feature branches (<code>git checkout -b &lt;NAME_OF_BRANCH&gt;</code>) to introduce changes to the source.</li> <li>Merge requests are made when we intend to merge the commits made to a feature branch to <code>master</code>.</li> <li>While one works on a feature branch, it is recommended that changes pushed to the <code>master</code> are pulled to the feature branch itself on a consistent basis. This allows the feature branch to possess the latest changes pushed by other developers through their own feature branches. In the example above, commits from the <code>master</code> branch following a merge of the <code>add-hidden-layer</code> branch are pulled into the <code>change-training-image</code> branch while that branch still expects further changes.</li> <li>The command <code>git pull</code> can be used to pull and sync these changes. However, it's recommended that developers make use of <code>git fetch</code> and <code>git log</code> to observe incoming changes first rather than pulling in changes in an indiscriminate manner.</li> <li>While it's possible for commits to be made directly to the <code>master</code> branch, it's recommended that they are kept minimal, at least for GitHub flow <em>(other workflows might not heed such practices)</em>.</li> </ul> <p>As we move along, we should be able to relate parts of the flow described above with the stages defined by the default GitLab CI pipeline.</p> <h2 id=environment-variables>Environment Variables<a class=headerlink href=#environment-variables title="Permanent link">&para;</a></h2> <p>Before we can make use of the GitLab CI pipeline, we would have to define the following variables for the pipeline beforehand:</p> <ul> <li><code>GCP_PROJECT_ID</code>: The ID of the GCP project for which container images are to be pushed to or where apps are to be deployed to.</li> <li><code>GCP_SERVICE_ACCOUNT_KEY</code>: A service account's JSON key that is to be used for communicating with GCP services.</li> <li><code>PRED_MODEL_UUID</code>: Unique ID of the MLflow run associated with a default model to be used for building the images of the following services: batch inferencing, FastAPI server and Streamlit app. Technically, this can be UUID for any baseline model or an arbitrary string as it can be overridden when the containers are being run.</li> </ul> <p>To define CI/CD variables for a project (repository), follow the steps listed <a href=https://docs.gitlab.com/ee/ci/variables/#add-a-cicd-variable-to-a-project>here</a>. For <code>GCP_PROJECT_ID</code> and <code>PRED_MODEL_UUID</code>, they are to be of <code>Variable</code> type while <code>GCP_SERVICE_ACCOUNT_KEY</code> needs to be a <code>File</code> type.</p> <p><strong>Reference(s):</strong></p> <ul> <li><a href=https://docs.gitlab.com/ee/ci/variables/ >GitLab Docs - GitLab CI/CD variables</a></li> </ul> <h2 id=stages-jobs>Stages &amp; Jobs<a class=headerlink href=#stages-jobs title="Permanent link">&para;</a></h2> <p>In the default pipeline, we have 3 stages defined:</p> <ul> <li><code>test</code>: For every push to certain branches, the source code residing in <code>src</code> will be tested.</li> <li><code>build</code>: Assuming the automated tests are passed, the pipeline will build Docker images, making use of the latest source.</li> <li><code>deploy-docs</code>: This stage is for the purpose of deploying a static site through <a href=https://docs.gitlab.com/ee/user/project/pages/ >GitLab Pages</a>. More on this stage is covered in <a href=../11-documentation/ >"Documentation"</a>.</li> </ul> <p>These stages are defined and listed like so:</p> <div class=tabbed-set data-tabs=1:1><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class=nt>stages</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deploy-docs</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>The jobs for each of the stages are executed using Docker images defined by users. For this, we have to specify in the pipeline the tag associated with the GitLab Runner that has the <a href=https://docs.gitlab.com/runner/executors/docker.html>Docker executor</a>. In our case, the tag for the relevant runner is <code>dind</code>.</p> <div class=tabbed-set data-tabs=2:1><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nt>default</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dind</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <h2 id=automated-testing-linting>Automated Testing &amp; Linting<a class=headerlink href=#automated-testing-linting title="Permanent link">&para;</a></h2> <p>Let's look at the job defined for the <code>test</code>stage first:</p> <div class=tabbed-set data-tabs=3:1><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class="l l-Scalar l-Scalar-Plain">test:pylint-pytest</span><span class="p p-Indicator">:</span><span class=w></span>
<span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class=w></span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">continuumio/miniconda:4.7.12</span><span class=w></span>
<span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">conda env create -f {{cookiecutter.repo_name}}-conda-env.yml</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source activate {{cookiecutter.repo_name}}</span><span class=w></span>
<span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pylint src --fail-under=7.0 --ignore=tests --disable=W1202</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pytest src/tests</span><span class=w></span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_MERGE_REQUEST_IID</span><span class=w></span>
<span class=w>      </span><span class=nt>changes</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">src/**/*</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">conf/**/*</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &quot;push&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_TAG</span><span class=w></span>
<span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">never</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>First of all, this <code>test:pylint-pytest</code> job will only execute on the condition that the defined <a href=https://docs.gitlab.com/ee/ci/yaml/#rules><code>rules</code></a> are met. In this case, the job will only execute for the following cases:</p> <ul> <li>For any pushes to any branch.</li> <li>For pushes to branches which merge requests have been created, tests are executed only if there are changes made to any files within <code>src</code> or <code>conf</code> are detected. This is to prevent automated tests from running for pushes made to feature branches with merge requests when no changes have been made to files for which tests are relevant. Otherwise, tests will run in a redundant manner, slowing down the feedback loop.</li> <li>If the push action is associated with a tag (<code>git push &lt;remote&gt; &lt;tag_name&gt;</code>), the job will not run.</li> </ul> <p>The job defined above fails under any of the following conditions:</p> <ul> <li>The source code does not meet a linting score of at least 6.5.</li> <li>The source code fails whatever tests have been defined under <code>src/tests</code>.</li> </ul> <p>The job would have to succeed before moving on to the <code>build</code> stage. Otherwise, no Docker images will be built. This is so that source code that fail tests would never be packaged.</p> <p><strong>Reference(s):</strong></p> <ul> <li><a href=https://docs.gitlab.com/ee/ci/variables/predefined_variables.html>GitLab Docs - Predefined variables reference</a></li> <li><a href=https://realpython.com/pytest-python-testing/ >Real Python - Effective Python Testing With Pytest</a></li> <li><a href=https://code.visualstudio.com/docs/python/linting>VSCode Docs - Linting Python in Visual Studio Code</a></li> </ul> <h2 id=automated-builds>Automated Builds<a class=headerlink href=#automated-builds title="Permanent link">&para;</a></h2> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>The template has thus far introduced a couple of Docker images relevant for the team. The tags for all the Docker images are listed below: {% if cookiecutter.gcr_personal_subdir == 'No' %} - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/vscode-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/jupyter-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/data-prep</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/model-train</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/fastapi-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/batch-inference</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/streamlit</code> {% elif cookiecutter.gcr_personal_subdir == 'Yes' %} - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/vscode-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/jupyter-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/data-prep</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/model-train</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/fastapi-server</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/batch-inference</code> - <code>asia.gcr.io/{{cookiecutter.gcp_project_id}}/{{cookiecutter.author_name}}/streamlit</code> {% endif %} The <code>build</code> stage aims at automating the building of these Docker images in a parallel manner. Let's look at a snippet for a single job that builds a Docker image:</p> <div class=tabbed-set data-tabs=4:1><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class="l l-Scalar l-Scalar-Plain">build:fastapi-server-image</span><span class="p p-Indicator">:</span><span class=w></span>
<span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class=w></span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io/kaniko-project/executor:debug</span><span class=w></span>
<span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/kaniko/gcp-sa.json</span><span class=w></span>
<span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mkdir -p /kaniko/.docker</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat $GCP_SERVICE_ACCOUNT_KEY &gt; /kaniko/gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">&gt;-</span><span class=w></span>
<span class=w>      </span><span class=no>/kaniko/executor</span><span class=w></span>
<span class=w>      </span><span class=no>--context &quot;${CI_PROJECT_DIR}&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>--dockerfile &quot;${CI_PROJECT_DIR}/docker/{{cookiecutter.repo_name}}-fastapi.Dockerfile&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>--build-arg PRED_MODEL_UUID=${PRED_MODEL_UUID}</span><span class=w></span>
<span class=w>      </span><span class=no>--destination &quot;asia.gcr.io/${GCP_PROJECT_ID}/fastapi-server:${CI_COMMIT_SHORT_SHA}&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_MERGE_REQUEST_IID</span><span class=w></span>
<span class=w>      </span><span class=nt>changes</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker/{{cookiecutter.repo_name}}-fastapi.Dockerfile</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">src/**/*</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">conf/**/*</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">scripts/**/*</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=5:1><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><label for=__tabbed_5_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class="l l-Scalar l-Scalar-Plain">build:fastapi-server-image</span><span class="p p-Indicator">:</span><span class=w></span>
<span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class=w></span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io/kaniko-project/executor:debug</span><span class=w></span>
<span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/kaniko/gcp-sa.json</span><span class=w></span>
<span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mkdir -p /kaniko/.docker</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat $GCP_SERVICE_ACCOUNT_KEY &gt; /kaniko/gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">&gt;-</span><span class=w></span>
<span class=w>      </span><span class=no>/kaniko/executor</span><span class=w></span>
<span class=w>      </span><span class=no>--context &quot;${CI_PROJECT_DIR}&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>--dockerfile &quot;${CI_PROJECT_DIR}/docker/{{cookiecutter.repo_name}}-fastapi.Dockerfile&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>--build-arg PRED_MODEL_UUID=${PRED_MODEL_UUID}</span><span class=w></span>
<span class=w>      </span><span class=no>--destination &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/fastapi-server:${CI_COMMIT_SHORT_SHA}&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_MERGE_REQUEST_IID</span><span class=w></span>
<span class=w>      </span><span class=nt>changes</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">docker/{{cookiecutter.repo_name}}-fastapi.Dockerfile</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">src/**/*</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">conf/**/*</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">scripts/**/*</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>{% endif %}</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You would have noticed that the jobs for building images utilise the command <code>/kaniko/executor</code> as opposed to <code>docker build</code> which most users would be more familiar with. This is due to the usage of <a href=https://github.com/GoogleContainerTools/kaniko><code>kaniko</code></a> within a runner with a Docker executor. Using Docker within Docker (<a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker>Docker-in-Docker</a>) requires privileged mode that poses several security concerns. Hence, the image <code>gcr.io/kaniko-project/executor:debug</code> is being used for all <code>build</code> jobs related to building of Docker images. That being said, the flags used for <code>kaniko</code> corresponds well with the flags usually used for <code>docker</code> commands.</p> </div> <p>Just like with the <code>test</code> job, the each of the jobs under <code>build</code> will execute under certain conditions:</p> <ul> <li>If a push is being done to a branch which has a merge request opened, a check would be done to see if any changes were made to folders like <code>src</code>, <code>conf</code>, <code>scripts</code>, or the relevant Dockerfile itself. If there are changes, the job will be executed. An opened merge request is detected through the predefined variable <code>CI_MERGE_REQUEST_IID</code>.</li> <li>If a push is being made to the default branch (<code>CI_DEFAULT_BRANCH</code>) of the repo, which in most cases within our organisation would be <code>master</code>, the job would execute as well. Recalling the <code>test</code> stage, any pushes to the repo would trigger the automated tests and linting. If a push to the <code>master</code> branch passes the tests, all Docker images will be built, regardless of whether changes have been made to files relevant to the Docker images to be built themselves.</li> </ul> <p>Images built through the pipeline will be tagged with the commit hashes associated with the commits that triggered it. This is seen through the usage of the predefined variable <code>CI_COMMIT_SHORT_SHA</code>.</p> <p><strong>Reference(s):</strong></p> <ul> <li><a href=https://docs.gitlab.com/ee/ci/docker/using_kaniko.html>GitLab Docs - Use kaniko to build Docker images</a></li> <li><a href=https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker>GitLab Docs - Use Docker to build Docker images</a></li> </ul> <h2 id=tagging>Tagging<a class=headerlink href=#tagging title="Permanent link">&para;</a></h2> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>As mentioned, pushes to the default branch would trigger builds for Docker images and they would be tagged with the commit hash. However, such commit hashes aren't the best way to tag "finalised" Docker images so the usage of tags would be more appropriate here. Hence, for the job defined below, it would only trigger if a tag is pushed to the default branch and only the default branch. The tag pushed (say through a command like <code>git push &lt;remote&gt; &lt;tag&gt;</code>) to the default branch on the remote would have the runner <strong>retag</strong> the Docker image that exists on GCR with the tag that is being pushed. The relevant images to be retagged are originally tagged with the short commit hash obtained from the commit that was pushed to the default branch before this.</p> <div class=tabbed-set data-tabs=6:1><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><label for=__tabbed_6_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class="l l-Scalar l-Scalar-Plain">build:retag-images</span><span class="p p-Indicator">:</span><span class=w></span>
<span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class=w></span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">google/cloud-sdk:debian_component_based</span><span class=w></span>
<span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/gcp-sa.json</span><span class=w></span>
<span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat $GCP_SERVICE_ACCOUNT_KEY &gt; /gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud auth activate-service-account --key-file=/gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/vscode-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/vscode-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/jupyter-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/jupyter-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/data-prep:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/data-prep:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/model-train:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/model-train:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/fastapi-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/fastapi-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/batch-inference:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/batch-inference:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/streamlit:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/streamlit:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_TAG &amp;&amp; $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=7:1><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><label for=__tabbed_7_1><code>.gitlab-ci.yml</code></label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=nn>...</span><span class=w></span>
<span class="l l-Scalar l-Scalar-Plain">build:retag-images</span><span class="p p-Indicator">:</span><span class=w></span>
<span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">build</span><span class=w></span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">google/cloud-sdk:debian_component_based</span><span class=w></span>
<span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/gcp-sa.json</span><span class=w></span>
<span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cat $GCP_SERVICE_ACCOUNT_KEY &gt; /gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud auth activate-service-account --key-file=/gcp-sa.json</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/vscode-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/vscode-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/jupyter-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/jupyter-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/data-prep:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/data-prep:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/model-train:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/model-train:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/fastapi-server:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/fastapi-server:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/batch-inference:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/batch-inference:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcloud container images add-tag --quiet &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/streamlit:${CI_COMMIT_SHORT_SHA}&quot; &quot;asia.gcr.io/${GCP_PROJECT_ID}/{{cookiecutter.author_name}}/streamlit:${CI_COMMIT_TAG}&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">$CI_COMMIT_TAG &amp;&amp; $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span><span class=w></span>
<span class=nn>...</span><span class=w></span>
</code></pre></div> </div> </div> <p>{% endif %} <strong>Reference(S):</strong></p> <ul> <li><a href=https://docs.github.com/en/get-started/quickstart/github-flow>GitHub Docs - GitHub Flow</a></li> <li><a href=https://docs.gitlab.com/ee/topics/gitlab_flow.html>GitLab Docs - GitLab Flow</a></li> </ul> <h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">&para;</a></h2> <p>The stages and jobs defined in this default pipeline is rudimentary at best as there is much more that could be done with GitLab CI. Some examples off the top:</p> <ul> <li>automatically generate reports for datasets that arrive in regular intervals</li> <li>submit model training jobs following triggers invoked by the same pipeline</li> <li>automate the deployment of the FastAPI servers to the GKE clusters that is accessible by the service account provided to the repository</li> </ul> <p>There's much more that can be done but whatever has been shared thus far is hopefully enough for one to get started with CI/CD.</p> </article> </div> </div> <a href=# class="md-top md-icon" title="Back to top" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../09-batch-inferencing/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Batch Inferencing </div> </div> </a> <a href=../11-documentation/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Documentation </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2022 - AI Singapore </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://twitter.com/aisingapore target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/company/aisingapore target=_blank rel=noopener title=www.linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://www.instagram.com/ai_singapore/ target=_blank rel=noopener title=www.instagram.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.d351de03.min.js", "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.a1609d9a.min.js></script> </body> </html>