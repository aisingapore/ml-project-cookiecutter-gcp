<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content {{cookiecutter.description}}&quot;&quot;><meta name=author content={{cookiecutter.author_name}}><link rel=icon href=../../assets/favicon.svg><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.1.5"><title>Deployment - {{cookiecutter.project_name}}</title><link rel=stylesheet href=../../assets/stylesheets/main.bde7dde4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ef6f36e2.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style></head> <body dir=ltr data-md-color-scheme=aisg data-md-color-primary=red data-md-color-accent=red> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#deployment class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title={{cookiecutter.project_name}} class="md-header__button md-logo" aria-label={{cookiecutter.project_name}} data-md-component=logo> <img src=../../assets/aisg-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> {{cookiecutter.project_name}} </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Deployment </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=aisg data-md-color-primary=red data-md-color-accent=red type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/aisingapore/ml-project-cookiecutter-gcp title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aisingapore/ml-project-cookiecutter-gcp </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../01-prerequisites/ class="md-tabs__link md-tabs__link--active"> User Guide </a> </li> <li class=md-tabs__item> <a href=../../guide-for-admin/01-prerequisites/ class=md-tabs__link> Admin Guide </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title={{cookiecutter.project_name}} class="md-nav__button md-logo" aria-label={{cookiecutter.project_name}} data-md-component=logo> <img src=../../assets/aisg-logo.png alt=logo> </a> {{cookiecutter.project_name}} </label> <div class=md-nav__source> <a href=https://github.com/aisingapore/ml-project-cookiecutter-gcp title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> aisingapore/ml-project-cookiecutter-gcp </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> User Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User Guide" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01-prerequisites/ class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=../02-preface/ class=md-nav__link> Preface </a> </li> <li class=md-nav__item> <a href=../03-mlops-components-platform/ class=md-nav__link> MLOps Components & Platform </a> </li> <li class=md-nav__item> <a href=../04-dev-env/ class=md-nav__link> Development Environment </a> </li> <li class=md-nav__item> <a href=../05-virtual-env/ class=md-nav__link> Virtual Environment </a> </li> <li class=md-nav__item> <a href=../06-data-storage-versioning/ class=md-nav__link> Data Storage & Versioning </a> </li> <li class=md-nav__item> <a href=../07-job-orchestration/ class=md-nav__link> Job Orchestration </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Deployment <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Deployment </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#model-artifacts class=md-nav__link> Model Artifacts </a> </li> <li class=md-nav__item> <a href=#model-serving-fastapi class=md-nav__link> Model Serving (FastAPI) </a> <nav class=md-nav aria-label="Model Serving (FastAPI)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#local-server class=md-nav__link> Local Server </a> </li> <li class=md-nav__item> <a href=#pydantic-settings class=md-nav__link> Pydantic Settings </a> </li> <li class=md-nav__item> <a href=#docker-container class=md-nav__link> Docker Container </a> </li> <li class=md-nav__item> <a href=#deploy-to-gke class=md-nav__link> Deploy to GKE </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../09-batch-inferencing/ class=md-nav__link> Batch Inferencing </a> </li> <li class=md-nav__item> <a href=../10-cicd/ class=md-nav__link> CI/CD </a> </li> <li class=md-nav__item> <a href=../11-documentation/ class=md-nav__link> Documentation </a> </li> <li class=md-nav__item> <a href=../12-streamlit/ class=md-nav__link> Streamlit </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Admin Guide <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Admin Guide" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Admin Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guide-for-admin/01-prerequisites/ class=md-nav__link> Prerequisites </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#model-artifacts class=md-nav__link> Model Artifacts </a> </li> <li class=md-nav__item> <a href=#model-serving-fastapi class=md-nav__link> Model Serving (FastAPI) </a> <nav class=md-nav aria-label="Model Serving (FastAPI)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#local-server class=md-nav__link> Local Server </a> </li> <li class=md-nav__item> <a href=#pydantic-settings class=md-nav__link> Pydantic Settings </a> </li> <li class=md-nav__item> <a href=#docker-container class=md-nav__link> Docker Container </a> </li> <li class=md-nav__item> <a href=#deploy-to-gke class=md-nav__link> Deploy to GKE </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=deployment>Deployment<a class=headerlink href=#deployment title="Permanent link">&para;</a></h1> <p>Assuming we have a predictive model that we are satisfied with, we can serve it within a REST API service with which requests can be made to and predictions are returned.</p> <p>Python has plenty of web frameworks that we can leverage on to build our REST API. Popular examples include <a href=https://flask.palletsprojects.com/en/2.0.x/ >Flask</a>, <a href=https://www.djangoproject.com/ >Django</a> and <a href=https://www.starlette.io/ >Starlette</a>. For this guide however, we will resort to the well-known <a href=https://fastapi.tiangolo.com/ >FastAPI</a> (which is based on Starlette itself).</p> <p><strong>Reference(s):</strong></p> <ul> <li><a href="https://www.youtube.com/watch?v=lsMQRaeKNDk">IBM Technology - What is a REST API? (Video)</a></li> </ul> <h2 id=model-artifacts>Model Artifacts<a class=headerlink href=#model-artifacts title="Permanent link">&para;</a></h2> <p>Seen in <a href=../07-job-orchestration/#model-training>"Model Training"</a> , we have the trained models uploaded to GCS through the MLflow Tracking server (done through autolog). With that, we have the following pointers to take note of:</p> <ul> <li>By default, each MLflow experiment run is given a unique ID.</li> <li _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>When artifacts are uploaded to GCS through MLflow, the artifacts are located within directories named after the unique IDs of the runs.</li> <li>This guide by default uploads your artifacts to the following directory on GCS: <code>gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server</code>.</li> <li _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir elif=elif>Artifacts for specific runs will be uploaded to a directory with a convention similar to the following: <code>gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/&lt;MLFLOW_EXPERIMENT_UUID&gt;</code>.</li> <li>This guide by default uploads your artifacts to the following directory on GCS: <code>gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/{{cookiecutter.author_name}}</code>.</li> <li _=% endif=endif>Artifacts for specific runs will be uploaded to a directory with a convention similar to the following: <code>gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/{{cookiecutter.author_name}}/&lt;MLFLOW_EXPERIMENT_UUID&gt;</code>.</li> <li>With this path/URI, we can use <a href=https://cloud.google.com/storage/docs/gsutil><code>gsutil</code></a> to download the predictive model from GCS into a mounted volume when we run the Docker image for the REST APIs.</li> </ul> <p>Now that we have established on how we are to obtain the models for the API server, let's look into the servers themselves.</p> <h2 id=model-serving-fastapi>Model Serving (FastAPI)<a class=headerlink href=#model-serving-fastapi title="Permanent link">&para;</a></h2> <p>FastAPI is a web framework that has garnered much popularity in recent years due to ease of adoption with its comprehensive tutorials, type and schema validation, being async capable and having automated docs, among other things. These factors have made it a popular framework within AI Singapore across many projects.</p> <p>If you were to inspect the <code>src</code> folder, you would notice that there exist more than one package:</p> <ul> <li><code>{{cookiecutter.src_package_name}}</code></li> <li><code>{{cookiecutter.src_package_name}}_fastapi</code></li> </ul> <p>The former contains the modules for executing pipelines like data preparation and model training while the latter is dedicated to modules meant for the REST API. Regardless, the packages can be imported by each other.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>It is recommended that you grasp some basics of the FastAPI framework, up till the <a href=https://fastapi.tiangolo.com/tutorial/ >beginner tutorials</a> for better understanding of this section.</p> </div> <p>Let's try running the boilerplate API server on a local machine. Before doing that, identify from the MLflow dashboard the unique ID of the experiment run that resulted in the predictive model that you would like to serve.</p> <p><img alt="MLflow - Dashboard Run View" src=../../assets/screenshots/mlflow-dashboard-run-view.png></p> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>With reference to the example screenshot above, the UUID for the experiment run is <code>7251ac3655934299aad4cfebf5ffddbe</code>. Once the ID of the MLflow run has been obtained, let's download the model that we intend to serve. Assuming you're in the root of this template's repository, execute the following commands:</p> <div class=tabbed-set data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ <span class=nb>export</span> <span class=nv>PRED_MODEL_UUID</span><span class=o>=</span><span class=s2>&quot;&lt;MLFLOW_EXPERIMENT_UUID&gt;&quot;</span>
$ <span class=nb>export</span> <span class=nv>PRED_MODEL_GCS_URI</span><span class=o>=</span><span class=s2>&quot;gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/</span><span class=nv>$PRED_MODEL_UUID</span><span class=s2>&quot;</span>
$ gsutil cp -r <span class=nv>$PRED_MODEL_GCS_URI</span> ./models
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=nv>$Env:PRED_MODEL_UUID</span><span class=p>=</span><span class=s1>&#39;&lt;MLFLOW_EXPERIMENT_UUID&gt;&#39;</span>
<span class=p>$</span> <span class=nv>$PRED_MODEL_GCS_URI</span><span class=p>=</span><span class=s2>&quot;gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/$Env:PRED_MODEL_UUID&quot;</span>
<span class=p>$</span> <span class=n>gsutil</span> <span class=nb>cp </span><span class=n>-r</span> <span class=nv>$PRED_MODEL_GCS_URI</span> <span class=p>.\</span><span class=n>models</span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ <span class=nb>export</span> <span class=nv>PRED_MODEL_UUID</span><span class=o>=</span><span class=s2>&quot;&lt;MLFLOW_EXPERIMENT_UUID&gt;&quot;</span>
$ <span class=nb>export</span> <span class=nv>PRED_MODEL_GCS_URI</span><span class=o>=</span><span class=s2>&quot;gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/{{cookiecutter.author_name}}/</span><span class=nv>$PRED_MODEL_UUID</span><span class=s2>&quot;</span>
$ gsutil cp -r <span class=nv>$PRED_MODEL_GCS_URI</span> ./models
</code></pre></div> </div> <input id=__tabbed_2_2 name=__tabbed_2 type=radio><label for=__tabbed_2_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=nv>$Env:PRED_MODEL_UUID</span><span class=p>=</span><span class=s1>&#39;&lt;MLFLOW_EXPERIMENT_UUID&gt;&#39;</span>
<span class=p>$</span> <span class=nv>$PRED_MODEL_GCS_URI</span><span class=p>=</span><span class=s2>&quot;gs://{{cookiecutter.repo_name}}-artifacts/mlflow-tracking-server/{{cookiecutter.author_name}}/$Env:PRED_MODEL_UUID&quot;</span>
<span class=p>$</span> <span class=n>gsutil</span> <span class=nb>cp </span><span class=n>-r</span> <span class=nv>$PRED_MODEL_GCS_URI</span> <span class=p>.\</span><span class=n>models</span>
</code></pre></div> </div> </div> <p>{% endif %} Executing the commands above will download the artifacts related to the experiment run <code>&lt;MLFLOW_EXPERIMENT_UUID&gt;</code> to this repository's subdirectory <code>models</code>. However, the specific subdirectory that is relevant for TensorFlow to load will be <code>./models/&lt;MLFLOW_EXPERIMENT_UUID&gt;/artifacts/model/data/model</code>. Let's export this path to an environment variable:</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>See <a href=https://www.tensorflow.org/tutorials/keras/save_and_load#savedmodel_format>here</a> for more information on the <code>SavedModel</code> format that TensorFlow uses for exporting trained models through the function call <code>model.save</code>.</p> </div> <div class=tabbed-set data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ <span class=nb>export</span> <span class=nv>PRED_MODEL_PATH</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$PWD</span><span class=s2>/models/</span><span class=nv>$PRED_MODEL_UUID</span><span class=s2>/artifacts/model/data/model&quot;</span>
</code></pre></div> </div> <input id=__tabbed_3_2 name=__tabbed_3 type=radio><label for=__tabbed_3_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=nv>$Env:PRED_MODEL_PATH</span><span class=p>=</span><span class=s2>&quot;</span><span class=p>$(</span><span class=nb>Get-Location</span><span class=p>)</span><span class=s2>\models\$Env:PRED_MODEL_UUID\artifacts\model\data\model&quot;</span>
</code></pre></div> </div> </div> <h3 id=local-server>Local Server<a class=headerlink href=#local-server title="Permanent link">&para;</a></h3> <p>Run the FastAPI server using <a href=https://gunicorn.org>Gunicorn</a> (for Linux/macOS) or <a href=https://www.uvicorn.org/ ><code>uvicorn</code></a> (for Windows):</p> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p>Gunicorn is only executable on UNIX-based or UNIX-like systems, this method would not be possible/applicable for Windows machine.</p> </div> <div class=tabbed-set data-tabs=4:2><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ conda activate <span class=o>{{</span>cookiecutter.repo_name<span class=o>}}</span>
$ <span class=nb>cd</span> src
$ gunicorn <span class=o>{{</span>cookiecutter.src_package_name<span class=o>}}</span>_fastapi.main:APP -b <span class=m>0</span>.0.0.0:8080 -w <span class=m>4</span> -k uvicorn.workers.UvicornWorker
</code></pre></div> <p>See <a href=https://fastapi.tiangolo.com/deployment/server-workers/ >here</a> as to why Gunicorn is to be used instead of just <a href=https://www.uvicorn.org/ >Uvicorn</a>. TLDR: Gunicorn is needed to spin up multiple processes/workers to handle more requests i.e. better for the sake of production needs.</p> </div> <input id=__tabbed_4_2 name=__tabbed_4 type=radio><label for=__tabbed_4_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>conda</span> <span class=n>activate</span> <span class=p>{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>repo_name</span><span class=p>}}</span>
<span class=p>$</span> <span class=nb>cd </span><span class=n>src</span>
<span class=p>$</span> <span class=n>uvicorn</span> <span class=p>{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>src_package_name</span><span class=p>}}</span><span class=n>_fastapi</span><span class=p>.</span><span class=n>main</span><span class=p>:</span><span class=n>APP</span>
</code></pre></div> </div> </div> <p>In another terminal, use the <code>curl</code> command to submit a request to the API:</p> <div class=tabbed-set data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><label for=__tabbed_5_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ curl -H <span class=s1>&#39;Content-Type: application/json&#39;</span> -H <span class=s1>&#39;accept: application/json&#39;</span> <span class=se>\</span>
    -X POST -d <span class=s1>&#39;{&quot;reviews&quot;: [{&quot;id&quot;: 9176, &quot;text&quot;: &quot;This movie is quite boring.&quot;}, {&quot;id&quot;: 71, &quot;text&quot;: &quot;This movie is awesome.&quot;}]}&#39;</span> <span class=se>\</span>
  localhost:8080/api/v1/model/predict
</code></pre></div> </div> <input id=__tabbed_5_2 name=__tabbed_5 type=radio><label for=__tabbed_5_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>curl</span><span class=p>.</span><span class=n>exe</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Type: application/json&#39;</span><span class=p>,</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;accept: application/json&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;-X&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span> <span class=s1>&#39;-d&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;{\&quot;reviews\&quot;: [{\&quot;id\&quot;: 9176, \&quot;text\&quot;: \&quot;This movie is quite boring.\&quot;}, {\&quot;id\&quot;: 71, \&quot;text\&quot;: \&quot;This movie is awesome.\&quot;}]}&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;localhost:8000/api/v1/model/predict&#39;</span>
</code></pre></div> </div> </div> <p>With the returned JSON object, we have successfully submitted a request to the FastAPI server and it returned predictions as part of the response.</p> <h3 id=pydantic-settings>Pydantic Settings<a class=headerlink href=#pydantic-settings title="Permanent link">&para;</a></h3> <p>Now you might be wondering, how does the FastAPI server knows the path to the model for it to load? FastAPI utilises <a href=https://pydantic-docs.helpmanual.io/ >Pydantic</a>, a library for data and schema validation, as well as <a href="https://fastapi.tiangolo.com/advanced/settings/?h=env#pydantic-settings">settings management</a>. There's a class called <code>Settings</code> under the module <code>src/{{cookiecutter.src_package_name}}_fastapi/config.py</code>. This class contains several fields: some are defined and some others not. The fields <code>PRED_MODEL_UUID</code> and <code>PRED_MODEL_PATH</code> inherit their values from the environment variables.</p> <p><code>src/{{cookiecutter.src_package_name}}_fastapi/config.py</code>: <div class=highlight><pre><span></span><code><span class=o>...</span>
<span class=k>class</span> <span class=nc>Settings</span><span class=p>(</span><span class=n>pydantic</span><span class=o>.</span><span class=n>BaseSettings</span><span class=p>):</span>

    <span class=n>API_NAME</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;{{cookiecutter.src_package_name}}_fastapi&quot;</span>
    <span class=n>API_V1_STR</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;/api/v1&quot;</span>
    <span class=n>LOGGER_CONFIG_PATH</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;../conf/base/logging.yml&quot;</span>

    <span class=n>PRED_MODEL_UUID</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>PRED_MODEL_PATH</span><span class=p>:</span> <span class=nb>str</span>
<span class=o>...</span>
</code></pre></div></p> <p>FastAPI automatically generates interactive API documentation for easy viewing of all the routers/endpoints you have made available for the server. You can view the documentation through <code>&lt;API_SERVER_URL&gt;:&lt;PORT&gt;/docs</code>. In our case here, it is viewable through <a href=http://localhost:8080/docs><code>localhost:8080/docs</code></a>. It will look like such:</p> <p><img alt="FastAPI - OpenAPI Docs" src=../../assets/screenshots/fastapi-openapi-docs.png></p> <h3 id=docker-container>Docker Container<a class=headerlink href=#docker-container title="Permanent link">&para;</a></h3> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>We now look into packaging the server within a Docker image. This process of containerising the server isn't just for the sake of reproducibility but it makes it easier for the server to be deployed on any server/infrastructure that can run a Docker container. A boilerplate Dockerfile is provided to containerise the FastAPI server:</p> <div class=tabbed-set data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><label for=__tabbed_6_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ <span class=nb>export</span> <span class=nv>GCP_PROJECT_ID</span><span class=o>={{</span>cookiecutter.gcp_project_id<span class=o>}}</span>
<span class=c1># Ensure that you are in the root of the repository</span>
$ docker build <span class=se>\</span>
    -t asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/fastapi-server:0.1.0 <span class=se>\</span>
    --build-arg <span class=nv>PRED_MODEL_UUID</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$PRED_MODEL_UUID</span><span class=s2>&quot;</span> <span class=se>\</span>
    -f docker/<span class=o>{{</span>cookiecutter.repo_name<span class=o>}}</span>-fastapi.Dockerfile <span class=se>\</span>
    --platform linux/amd64 .
</code></pre></div> </div> <input id=__tabbed_6_2 name=__tabbed_6 type=radio><label for=__tabbed_6_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=nv>$GCP_PROJECT_ID</span><span class=p>=</span><span class=s1>&#39;{{cookiecutter.gcp_project_id}}&#39;</span>
<span class=c># Ensure that you are in the root of the repository</span>
<span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>`</span>
    <span class=n>-t</span> <span class=n>asia</span><span class=p>.</span><span class=n>gcr</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nv>$GCP_PROJECT_ID</span><span class=p>/</span><span class=n>fastapi-server</span><span class=p>:</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>0</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-build-arg</span> <span class=n>PRED_MODEL_UUID</span><span class=p>=</span><span class=s2>&quot;$Env:PRED_MODEL_UUID&quot;</span> <span class=p>`</span>
    <span class=o>-f</span> <span class=n>docker</span><span class=p>/{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>repo_name</span><span class=p>}}</span><span class=n>-fastapi</span><span class=p>.</span><span class=n>Dockerfile</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-platform</span> <span class=n>linux</span><span class=p>/</span><span class=n>amd64</span> <span class=p>.</span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=7:2><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><label for=__tabbed_7_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ <span class=nb>export</span> <span class=nv>GCP_PROJECT_ID</span><span class=o>={{</span>cookiecutter.gcp_project_id<span class=o>}}</span>
<span class=c1># Ensure that you are in the root of the repository</span>
$ docker build <span class=se>\</span>
    -t asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/<span class=o>{{</span>cookiecutter.author_name<span class=o>}}</span>/fastapi-server:0.1.0 <span class=se>\</span>
    --build-arg <span class=nv>PRED_MODEL_UUID</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$PRED_MODEL_UUID</span><span class=s2>&quot;</span> <span class=se>\</span>
    -f docker/<span class=o>{{</span>cookiecutter.repo_name<span class=o>}}</span>-fastapi.Dockerfile <span class=se>\</span>
    --platform linux/amd64 .
</code></pre></div> </div> <input id=__tabbed_7_2 name=__tabbed_7 type=radio><label for=__tabbed_7_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=nv>$GCP_PROJECT_ID</span><span class=p>=</span><span class=s1>&#39;{{cookiecutter.gcp_project_id}}&#39;</span>
<span class=c># Ensure that you are in the root of the repository</span>
<span class=p>$</span> <span class=n>docker</span> <span class=n>build</span> <span class=p>`</span>
    <span class=n>-t</span> <span class=n>asia</span><span class=p>.</span><span class=n>gcr</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nv>$GCP_PROJECT_ID</span><span class=p>/{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>author_name</span><span class=p>}}/</span><span class=n>fastapi-server</span><span class=p>:</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>0</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-build-arg</span> <span class=n>PRED_MODEL_UUID</span><span class=p>=</span><span class=s2>&quot;$Env:PRED_MODEL_UUID&quot;</span> <span class=p>`</span>
    <span class=o>-f</span> <span class=n>docker</span><span class=p>/{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>repo_name</span><span class=p>}}</span><span class=n>-fastapi</span><span class=p>.</span><span class=n>Dockerfile</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-platform</span> <span class=n>linux</span><span class=p>/</span><span class=n>amd64</span> <span class=p>.</span>
</code></pre></div> </div> </div> <p>{% endif %} The Docker build command above requires an argument to be passed and it is basically the same unique MLflow run ID that was used above. The ID would then be used to create environment variables that would persist beyond the build time. When the container is being run, these environment variables would be used by the entrypoint script (<code>scripts/fastapi/api-entrypoint.sh</code>) to download the relevant predictive model into the mounted volumes and be referred to by the FastAPI Pydantic models.</p> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>Let's try running the Docker container now:</p> <div class=tabbed-set data-tabs=8:2><input checked=checked id=__tabbed_8_1 name=__tabbed_8 type=radio><label for=__tabbed_8_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1># First make the `models` folder accessible to user within Docker container</span>
$ sudo chgrp -R <span class=m>2222</span> models
$ docker run --rm -p <span class=m>8080</span>:8080 <span class=se>\</span>
    --name fastapi-server <span class=se>\</span>
    -v &lt;PATH_TO_SA_JSON_FILE&gt;:/var/secret/cloud.google.com/gcp-service-account.json <span class=se>\</span>
    -v <span class=nv>$PWD</span>/models:/home/aisg/from-gcs <span class=se>\</span>
    --env <span class=nv>GOOGLE_APPLICATION_CREDENTIALS</span><span class=o>=</span>/var/secret/cloud.google.com/gcp-service-account.json <span class=se>\</span>
    asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/fastapi-server:0.1.0
</code></pre></div> </div> <input id=__tabbed_8_2 name=__tabbed_8 type=radio><label for=__tabbed_8_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-rm</span> <span class=n>-p</span> <span class=n>8080</span><span class=p>:</span><span class=n>8080</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-name</span> <span class=n>fastapi-server</span> <span class=p>`</span>
    <span class=n>-v</span> <span class=s2>&quot;&lt;PATH_TO_SA_JSON_FILE&gt;:/var/secret/cloud.google.com/gcp-service-account.json&quot;</span> <span class=p>`</span>
    <span class=n>-v</span> <span class=s2>&quot;</span><span class=p>$(</span><span class=nb>Get-Location</span><span class=p>)</span><span class=s2>\models:/home/aisg/from-gcs&quot;</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-env</span> <span class=n>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>=</span><span class=s2>&quot;/var/secret/cloud.google.com/gcp-service-account.json&quot;</span> <span class=p>`</span>
    <span class=n>asia</span><span class=p>.</span><span class=n>gcr</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nv>$GCP_PROJECT_ID</span><span class=p>/</span><span class=n>fastapi-server</span><span class=p>:</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>0</span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=9:2><input checked=checked id=__tabbed_9_1 name=__tabbed_9 type=radio><label for=__tabbed_9_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1># First make the `models` folder accessible to user within Docker container</span>
$ sudo chgrp -R <span class=m>2222</span> models
$ docker run --rm -p <span class=m>8080</span>:8080 <span class=se>\</span>
    --name fastapi-server <span class=se>\</span>
    -v &lt;PATH_TO_SA_JSON_FILE&gt;:/var/secret/cloud.google.com/gcp-service-account.json <span class=se>\</span>
    -v <span class=nv>$PWD</span>/models:/home/aisg/from-gcs <span class=se>\</span>
    --env <span class=nv>GOOGLE_APPLICATION_CREDENTIALS</span><span class=o>=</span>/var/secret/cloud.google.com/gcp-service-account.json <span class=se>\</span>
    asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/<span class=o>{{</span>cookiecutter.author_name<span class=o>}}</span>/fastapi-server:0.1.0
</code></pre></div> </div> <input id=__tabbed_9_2 name=__tabbed_9 type=radio><label for=__tabbed_9_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>docker</span> <span class=n>run</span> <span class=p>-</span><span class=n>-rm</span> <span class=n>-p</span> <span class=n>8080</span><span class=p>:</span><span class=n>8080</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-name</span> <span class=n>fastapi-server</span> <span class=p>`</span>
    <span class=n>-v</span> <span class=s2>&quot;&lt;PATH_TO_SA_JSON_FILE&gt;:/var/secret/cloud.google.com/gcp-service-account.json&quot;</span> <span class=p>`</span>
    <span class=n>-v</span> <span class=s2>&quot;</span><span class=p>$(</span><span class=nb>Get-Location</span><span class=p>)</span><span class=s2>\models:/home/aisg/from-gcs&quot;</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-env</span> <span class=n>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>=</span><span class=s2>&quot;/var/secret/cloud.google.com/gcp-service-account.json&quot;</span> <span class=p>`</span>
    <span class=n>asia</span><span class=p>.</span><span class=n>gcr</span><span class=p>.</span><span class=n>io</span><span class=p>/</span><span class=nv>$GCP_PROJECT_ID</span><span class=p>/{{</span><span class=n>cookiecutter</span><span class=p>.</span><span class=n>author_name</span><span class=p>}}/</span><span class=n>fastapi-server</span><span class=p>:</span><span class=n>0</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>0</span>
</code></pre></div> </div> </div> <p>{% endif %} Let's go through a couple of the flags used above:</p> <ul> <li><code>--rm</code>: Automatically stops the container when it exits or when you stop it.</li> <li><code>-p</code>: This binds port <code>8080</code> of the container to port <code>8080</code> of the host machine.</li> <li><code>-v</code>: Bind mounts files or directories from the host machine to the container. In this case, we are mounting the SA file and the <code>models</code> folder to the container. The SA file is needed for <code>gsutil</code> to download the model from GCS and the <code>models</code> folder will persist the downloaded models.</li> <li><code>--env</code>: This sets environment variables within the container.</li> </ul> <p>Use the same <code>curl</code> command for the server spun up by the container:</p> <div class=tabbed-set data-tabs=10:2><input checked=checked id=__tabbed_10_1 name=__tabbed_10 type=radio><label for=__tabbed_10_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ curl -H <span class=s1>&#39;Content-Type: application/json&#39;</span> -H <span class=s1>&#39;accept: application/json&#39;</span> <span class=se>\</span>
    -X POST -d <span class=s1>&#39;{&quot;reviews&quot;: [{&quot;id&quot;: 9176, &quot;text&quot;: &quot;This movie is quite boring.&quot;}, {&quot;id&quot;: 71, &quot;text&quot;: &quot;This movie is awesome.&quot;}]}&#39;</span> <span class=se>\</span>
    localhost:8080/api/v1/model/predict
</code></pre></div> </div> <input id=__tabbed_10_2 name=__tabbed_10 type=radio><label for=__tabbed_10_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>curl</span><span class=p>.</span><span class=n>exe</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Type: application/json&#39;</span><span class=p>,</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;accept: application/json&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;-X&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span> <span class=s1>&#39;-d&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;{\&quot;reviews\&quot;: [{\&quot;id\&quot;: 9176, \&quot;text\&quot;: \&quot;This movie is quite boring.\&quot;}, {\&quot;id\&quot;: 71, \&quot;text\&quot;: \&quot;This movie is awesome.\&quot;}]}&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;localhost:8080/api/v1/model/predict&#39;</span>
</code></pre></div> </div> </div> <p>To stop the container:</p> <div class=highlight><pre><span></span><code>$ docker container stop fastapi-server
</code></pre></div> <p>Push the Docker image to the GCR: {% if cookiecutter.gcr_personal_subdir == 'No' %} <div class=highlight><pre><span></span><code>$ docker push asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/fastapi-server:0.1.0
</code></pre></div> {% elif cookiecutter.gcr_personal_subdir == 'Yes' %} <div class=highlight><pre><span></span><code>$ docker push asia.gcr.io/<span class=nv>$GCP_PROJECT_ID</span>/<span class=o>{{</span>cookiecutter.author_name<span class=o>}}</span>/fastapi-server:0.1.0
</code></pre></div> {% endif %} With this Docker image, you can spin up a VM (Compute Engine instance) that has Docker installed and run the container on it for deployment. You can also deploy the image within a Kubernetes cluster for ease of scaling.</p> <h3 id=deploy-to-gke>Deploy to GKE<a class=headerlink href=#deploy-to-gke title="Permanent link">&para;</a></h3> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>As this mode of deployment would take up resources in a long-running manner, please tear it down once you've gone through this part of the guide. If you do not have the right permissions, please request assistance from your team lead or the administrators.</p> </div> <p>To deploy the FastAPI server on GKE, you can make use of the sample Kubernetes manifest files provided with this template:</p> <div class=tabbed-set data-tabs=11:1><input checked=checked id=__tabbed_11_1 name=__tabbed_11 type=radio><label for=__tabbed_11_1>Local Machine</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ kubectl apply -f aisg-context/k8s/model-serving-api/fastapi-server-deployment.yml --namespace<span class=o>=</span>polyaxon-v1
$ kubectl apply -f aisg-context/k8s/model-serving-api/fastapi-server-service.yml --namespace<span class=o>=</span>polyaxon-v1
</code></pre></div> </div> </div> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>To access the server, you can port-forward the service to a local port like such:</p> <div class=tabbed-set data-tabs=12:1><input checked=checked id=__tabbed_12_1 name=__tabbed_12 type=radio><label for=__tabbed_12_1>Local Machine</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ kubectl port-forward service/fastapi-server-svc <span class=m>8080</span>:8080 --namespace<span class=o>=</span>polyaxon-v1
Forwarding from <span class=m>127</span>.0.0.1:8080 -&gt; <span class=m>8080</span>
Forwarding from <span class=o>[</span>::1<span class=o>]</span>:8080 -&gt; <span class=m>8080</span>
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=13:1><input checked=checked id=__tabbed_13_1 name=__tabbed_13 type=radio><label for=__tabbed_13_1>Local Machine</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ kubectl port-forward service/fastapi-server-<span class=o>{{</span>cookiecutter.author_name.replace<span class=o>(</span><span class=s1>&#39;_&#39;</span>, <span class=s1>&#39;-&#39;</span><span class=o>)}}</span>-svc <span class=m>8080</span>:8080 --namespace<span class=o>=</span>polyaxon-v1
Forwarding from <span class=m>127</span>.0.0.1:8080 -&gt; <span class=m>8080</span>
Forwarding from <span class=o>[</span>::1<span class=o>]</span>:8080 -&gt; <span class=m>8080</span>
</code></pre></div> </div> </div> <p>{% endif %} You can view the documentation for the API at <a href=http://localhost:8080/docs><code>http://localhost:8080/docs</code></a>. You can also make a request to the API like so:</p> <div class=tabbed-set data-tabs=14:2><input checked=checked id=__tabbed_14_1 name=__tabbed_14 type=radio><label for=__tabbed_14_1>Linux/macOS</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ curl -H <span class=s1>&#39;Content-Type: application/json&#39;</span> -H <span class=s1>&#39;accept: application/json&#39;</span> <span class=se>\</span>
    -X POST -d <span class=s1>&#39;{&quot;reviews&quot;: [{&quot;id&quot;: 9176, &quot;text&quot;: &quot;This movie is quite boring.&quot;}, {&quot;id&quot;: 71, &quot;text&quot;: &quot;This movie is awesome.&quot;}]}&#39;</span> <span class=se>\</span>
    localhost:8080/api/v1/model/predict
</code></pre></div> </div> <input id=__tabbed_14_2 name=__tabbed_14 type=radio><label for=__tabbed_14_2>Windows PowerShell</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=p>$</span> <span class=n>curl</span><span class=p>.</span><span class=n>exe</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Type: application/json&#39;</span><span class=p>,</span> <span class=s1>&#39;-H&#39;</span><span class=p>,</span> <span class=s1>&#39;accept: application/json&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;-X&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span> <span class=s1>&#39;-d&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;{\&quot;reviews\&quot;: [{\&quot;id\&quot;: 9176, \&quot;text\&quot;: \&quot;This movie is quite boring.\&quot;}, {\&quot;id\&quot;: 71, \&quot;text\&quot;: \&quot;This movie is awesome.\&quot;}]}&#39;</span><span class=p>,</span> <span class=p>`</span>
    <span class=s1>&#39;localhost:8080/api/v1/model/predict&#39;</span>
</code></pre></div> </div> </div> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p _=% cookiecutter.gcr_personal_subdir=cookiecutter.gcr_personal_subdir if=if>Please tear down the deployment and service objects once they are not required.</p> <div class=tabbed-set data-tabs=15:1><input checked=checked id=__tabbed_15_1 name=__tabbed_15 type=radio><label for=__tabbed_15_1>Local Machine</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ kubectl delete fastapi-server-deployment --namespace<span class=o>=</span>polyaxon-v1
$ kubectl delete fastapi-server-svc --namespace<span class=o>=</span>polyaxon-v1
</code></pre></div> </div> </div> <p>{% elif cookiecutter.gcr_personal_subdir == 'Yes' %}</p> <div class=tabbed-set data-tabs=16:1><input checked=checked id=__tabbed_16_1 name=__tabbed_16 type=radio><label for=__tabbed_16_1>Local Machine</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>$ kubectl delete fastapi-server-<span class=o>{{</span>cookiecutter.author_name.replace<span class=o>(</span><span class=s1>&#39;_&#39;</span>, <span class=s1>&#39;-&#39;</span><span class=o>)}}</span>-deployment --namespace<span class=o>=</span>polyaxon-v1
$ kubectl delete fastapi-server-<span class=o>{{</span>cookiecutter.author_name.replace<span class=o>(</span><span class=s1>&#39;_&#39;</span>, <span class=s1>&#39;-&#39;</span><span class=o>)}}</span>-svc --namespace<span class=o>=</span>polyaxon-v1
</code></pre></div> </div> </div> <p>{% endif %} If you do not have the right permissions, please request assistance from your team lead or the administrators.</p> </div> <p><strong>Reference(s):</strong></p> <ul> <li><a href=https://fastapi.tiangolo.com>FastAPI Docs</a></li> <li><a href=https://pydantic-docs.helpmanual.io/usage/settings/ >Pydantic Docs - Settings Management</a></li> <li><a href=https://www.tensorflow.org/api_docs/python/tf/keras/models/load_model>TensorFlow Docs - <code>tf.keras.models.load_model</code></a></li> <li><a href=https://curl.se/docs/manual.html><code>curl</code> tutorial</a></li> <li><a href=https://docs.docker.com/engine/reference/commandline/run/ ><code>docker run</code> Reference</a></li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" title="Back to top" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../07-job-orchestration/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Job Orchestration </div> </div> </a> <a href=../09-batch-inferencing/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Batch Inferencing </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2022 - AI Singapore </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://twitter.com/aisingapore target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/company/aisingapore target=_blank rel=noopener title=www.linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://www.instagram.com/ai_singapore/ target=_blank rel=noopener title=www.instagram.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.d351de03.min.js", "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.a1609d9a.min.js></script> </body> </html>